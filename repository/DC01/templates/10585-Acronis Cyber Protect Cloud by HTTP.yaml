zabbix_export:
  version: '6.0'
  date: '2024-08-25T12:38:17Z'
  groups:
    - uuid: a571c0d144b14fd4a87a9d9b2aa9fcd6
      name: Templates/Applications
  templates:
    - uuid: d0571c5f2c204b7ab244843040288a35
      template: 'Acronis Cyber Protect Cloud by HTTP'
      name: 'Acronis Cyber Protect Cloud by HTTP'
      description: |
        Requests Acronis Cyber Protect Cloud API access token and creates host prototype for MSP.
        
        Template uses HTTP item to query Acronis Cyber Protect Cloud API client for authorization.
        
        Read the template documentation prior to using this template.
        
        You can discuss this template or leave feedback on our forum https://www.zabbix.com/forum/zabbix-suggestions-and-feedback
        
        Generated by official Zabbix template tool "Templator"
      groups:
        - name: Templates/Applications
      items:
        - uuid: bce642c2c6e743ccb618c96f6ca533da
          name: 'Acronis CPC: Get access token'
          type: HTTP_AGENT
          key: acronis.cpc.account_manager.get_token
          delay: '{$ACRONIS.CPC.AUTH.INTERVAL}'
          history: '0'
          trends: '0'
          value_type: TEXT
          authtype: BASIC
          username: '{$ACRONIS.CPC.AUTH.CLIENT.ID}'
          password: '{$ACRONIS.CPC.AUTH.SECRET}'
          description: 'Authorizes API user and receives access token.'
          preprocessing:
            - type: JAVASCRIPT
              parameters:
                - |
                  value = JSON.parse(value);
                  
                  var list = [];
                  list.push({ 'scope': value['scope'].split(':')[3], 'access_token': value['access_token'] });
                  return JSON.stringify(list);
          timeout: 15s
          url: '{$ACRONIS.CPC.DATACENTER.URL}{$ACRONIS.CPC.PATH.ACCOUNT.MANAGEMENT}/idp/token'
          posts: grant_type=client_credentials
          status_codes: ''
          http_proxy: '{$ACRONIS.CPC.HTTP.PROXY}'
          headers:
            - name: Content-Type
              value: application/x-www-form-urlencoded
            - name: X-Application-Secret
              value: 5619386d-de56-49ec-8508-f5c399d3b9bd
          request_method: POST
          tags:
            - tag: component
              value: authorization
      discovery_rules:
        - uuid: d2c30d84c5f44734bc2f0ef38e99a959
          name: 'Acronis CPC: MSP Discovery'
          type: DEPENDENT
          key: acronis.cpc.lld.msp_discovery
          delay: '0'
          description: 'Discovers MSP and creates host prototype based on that.'
          host_prototypes:
            - uuid: bbdc747270f64876bc701dd87c27dbbe
              host: 'Acronis CPC MSP {#SCOPE}'
              name: 'Acronis CPC MSP {#SCOPE}'
              group_links:
                - group:
                    name: Templates/Applications
              templates:
                - name: 'Acronis Cyber Protect Cloud MSP by HTTP'
              macros:
                - macro: '{$ACRONIS.CPC.ACCESS_TOKEN}'
                  value: '{#ACCESS_TOKEN}'
                  description: 'Acronis CPC API access token.'
                - macro: '{$ACRONIS.CPC.MSP.TENANT.UUID}'
                  value: '{#SCOPE}'
                  description: 'UUID of API client tenant.'
          master_item:
            key: acronis.cpc.account_manager.get_token
          lld_macro_paths:
            - lld_macro: '{#ACCESS_TOKEN}'
              path: $.access_token
            - lld_macro: '{#SCOPE}'
              path: $.scope
      tags:
        - tag: class
          value: application
        - tag: target
          value: acronis
        - tag: target
          value: cyber-protect-cloud
      macros:
        - macro: '{$ACRONIS.CPC.AUTH.CLIENT.ID}'
          description: 'Client ID for API user access.'
        - macro: '{$ACRONIS.CPC.AUTH.INTERVAL}'
          value: 110m
          description: 'API token regeneration interval, in minutes. By default, Acronis Cyber Protect Cloud tokens expire after 2 hours.'
        - macro: '{$ACRONIS.CPC.AUTH.SECRET}'
          type: SECRET_TEXT
          description: 'Secret for API user access.'
        - macro: '{$ACRONIS.CPC.DATACENTER.URL}'
          description: 'Acronis Cyber Protect Cloud datacenter URL, e.g., https://eu2-cloud.acronis.com.'
        - macro: '{$ACRONIS.CPC.HTTP.PROXY}'
          description: 'Sets the HTTP proxy for the authorization item. Host prototypes will also use this value for HTTP proxy. If this parameter is empty, then no proxy is used.'
        - macro: '{$ACRONIS.CPC.PATH.ACCOUNT.MANAGEMENT}'
          value: /api/2
          description: 'Sub-path for the Account Management API.'
